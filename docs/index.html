<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name ="viewport" content="initial-scale=1.0, user-scalable=no">
<script src="https://kit.fontawesome.com/5cf062dc93.js"></script>
<script  src="script.js"></script>
<link rel="stylesheet" href="main.css">
<link rel="stylesheet" href="root.css">
<script  src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
<link ref="stylesheet"  href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css">



                <title>Infotainment</title>
                <meta name="apple-mobile-web-app-title" content="Infotainment">
                <meta name="application-name" content="Infotainment">
            

                <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
                <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
                <link rel="icon" type="image/png" sizes="16x16" href="favicon.png">
            





<div   ui="Import">

</div>
<div   ui="Import">
<div style="position:fixed;top:0;left:0;height:100vh;width:100vw;z-index:0;"  ui="block">
<div id='map' style="height:100%;width:100%;"  ui="block">
</div>
</div>
</div>
<div   ui="Import">

</div>
<div   ui="Import">

</div>
<div style="position:fixed;top:0;left:0;"  ui="v-stack">
<div style="width:fit-content;"  ui="Import">
<div style="padding:3.5rem;padding-top:2.05rem;padding-bottom:2.9rem;border-radius:0.5rem;line-height:1;align-items:baseline;"  ui="h-stack">
<div style="margin-right:0.5rem;font-size:100pt;font-weight:700;" ui="text" live='true' >{store.get("speed")}
</div>
<div style="font-size:25pt;font-weight:500;" ui="text">mph
</div>
</div>
</div>
<div style="width:fit-content;"  ui="Import">
<div id='SpeedLimit' style="margin:0 3.5rem;padding:1rem;background:rgb(255, 255, 255, 0.75);backdrop-filter:blur(10pt);line-height:1;color:black;text-align:center;border-radius:0.25rem;"  ui="v-stack">
<div style="font-size:14pt;font-weight:500;" ui="text">MAX
</div>
<div style="font-size:28pt;font-weight:700;" ui="text" live='true' >{store.get("speed limit")}
</div>
</div>
</div>
</div>
<div style="position:fixed;bottom:0;left:0;"  ui="v-stack">
<div   ui="Import">
<div style="margin:2rem;padding:1.5rem;background:var(--primary50);backdrop-filter:blur(1.5rem);border-radius:0.5rem;"  ui="v-stack">
<div style="font-size:16pt;font-weight:600;" ui="text" live='true' >{store.get("current city")}
</div>
<div style="opacity:0.9;" ui="text" live='true' >{store.get("current county")}
</div>
<div style="opacity:0.9;" ui="text" live='true' >{store.get("current state")}
</div>
<div style="margin-top:0.5rem;font-size:12pt;opacity:0.5;" ui="text" live='true' >{Icon("mountain")} {store.get("elevation")} ft
</div>
<div style="margin-top:0.25rem;font-size:12pt;opacity:0.5;" ui="text" live='true' >{Icon("location")} {store.get("position long").toFixed(2)}, {store.get("position lat").toFixed(2)}
</div>
</div>
</div>
</div>
<div style="position:fixed;top:0;right:0;"  ui="v-stack">
<div   ui="Import">
<div style="padding:2rem;"  ui="v-stack">
<div class='TopMapButton' onclick='currentLocation()'   ui="grid">
<div  ui="text" live='true' >{Icon("music")}
</div>
</div>
<div class='TopMapButton' onclick='currentLocation()'   ui="grid">
<div  ui="text" live='true' >{Icon("sliders")}
</div>
</div>
</div>
</div>
</div>
<div style="position:fixed;bottom:0;right:0;"  ui="v-stack">
<div   ui="Import">
<div style="padding:2rem;"  ui="v-stack">
<div class='BottomMapButton' onclick='toggleDimension()'   ui="grid">
<div  ui="text" live='true' >{store.get("dimension") == 2 ? "3D" : "2D"}
</div>
</div>
<div class='BottomMapButton' onclick='currentLocation()'   ui="grid">
<div  ui="text" live='true' >{Icon("location-dot")}
</div>
</div>
</div>
</div>
</div>
<div style="position:fixed;bottom:0;left:50vw;"  ui="block">
<div   ui="Import">
<div style="padding:0.5rem 2rem;margin-bottom:1.25rem;background:var(--primary50);backdrop-filter:blur(1.5rem);font-weight:500;border-radius:100vh;translate:-50% 0;" ui="text" live='true' >{store.get("road name")}
</div>
</div>
</div><style>
[ui="view"]{
    display: grid;
    align-content: start;
    padding: 4rem 1rem;
}

[ui="title"]{
    font-size: 30pt;
    font-weight: 700;
}

[ui="subtitle"]{
    font-size: 25pt;
    font-weight: 700;
    opacity: 0.6;
}

[ui="code-stack"]{
    padding: 1rem;
    font-family: 'Courier New', Courier, monospace;
    font-weight: 600;
    background: var(--l1);
}

[ui="grid"] {
    display: grid;
}

[ui="v-stack"]{
    display: block;
}

[ui="v-split-stack"]{
    display: grid;
    grid-template-rows: auto min-content;
}
[ui="v-push-stack"]{
    display: grid;
    grid-template-rows: auto min-content;
}
[ui="v-pull-stack"]{
    display: grid;
    grid-template-rows: min-content auto;
    align-items: end;
}

[ui="v-spread-stack"]{
    display: grid;
    grid-template-rows: repeat(auto-fit, minmax(1px, 1fr));
}

[ui="h-stack"] {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: max-content;
    overflow-x: auto;
}
[ui="h-stack"].snap{
    scroll-snap-type: x mandatory;
}
[ui="h-stack"].snap > * {
scroll-snap-align: start;
}

[ui="h-split-stack"]{
    display: grid;
    grid-template-columns: auto min-content;
    align-items: center;
}
[ui="h-push-stack"]{
    display: grid;
    grid-template-columns: auto min-content;
    align-items: center;
}
[ui="h-pull-stack"]{
    display: grid;
    grid-template-columns: min-content auto;
    align-items: center;
}

[ui="h-spread-stack"]{
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(1px, 1fr));
    align-items: center;
}

[ui="empty-photo"]{
    background: linear-gradient(to bottom right, var(--l3), var(--l1))
}

[ui="menu"]{
    position: absolute;
    height: 100vh;
    width: 100vw;
    background: var(--bg);
}

[ui="menu"][menu="list"]{
    display: grid;
    /* grid-template-rows: repeat(auto-fit, minmax(1px, 1fr)); */
    gap: 0.5rem;
    align-items: center;
    background: var(--l1);
}

[ui="menu"][menu="list"] [ui="option"]{
    display: flex;
    align-items: center;
    height: 100%;
    padding: 0 2rem;
    font-size: 20pt;
    font-weight: 500;
    background: var(--bg);
}

[ui="menu-close"]{
    /* background: red; */
    color: var(--red);
}

[custom_struct]{
    display: none;
}

.marker { position:absolute;top:0;left:0;height:1rem;width:1rem;background:var(--blue);outline:solid 0.1rem white;box-shadow:0 0 1.5rem 0.25rem var(--blue);font-size:25pt;border-radius:100vh; }





.TopMapButton { margin-bottom:1rem;padding:1.5rem;background:var(--primary50);backdrop-filter:blur(1.5rem);align-items:center;aspect-ratio:1 / 1;font-size:16pt;font-weight:600;text-align:center;cursor:pointer;border-radius:100vh; }
.BottomMapButton { margin-top:1rem;padding:1.5rem;background:var(--primary50);backdrop-filter:blur(1.5rem);align-items:center;aspect-ratio:1 / 1;font-size:16pt;font-weight:600;text-align:center;cursor:pointer;border-radius:100vh; }
</style><script>

window.addEventListener("DOMContentLoaded", () => {
    processCustomStructs()
    processLiveText()
    updateState()
})

let state_funcs = []
function updateState() {
    buildLiveText()
    buildEachStacks()
    buildCustomStructs()
    state_funcs.forEach(func => func())
}


let live_state = []
function processLiveText() {
    document.querySelectorAll(`[live]`).forEach(elem => {
        elem.setAttribute("live_state_index", live_state.length)
        live_state.push({
            html: elem.innerHTML,
            elem: elem
        })
    })
}
function buildLiveText() {
    document.querySelectorAll(`[live]`).forEach(elem => {
        let target = live_state[elem.getAttribute("live_state_index")]
        elem.innerHTML = evalString(decodeHTML(target.html))
    })
}

let each_stacks = []
function buildEachStacks() {
    document.querySelectorAll(`[each]`).forEach(elem => {
        let contents = []
        if (!elem.getAttribute("storage_index")) {
            let obj_html = elem.innerHTML
            let obj = {
                call: elem.getAttribute("call"),
                html: obj_html,
                evals: extractEvalStrings(obj_html)
            }
            elem.setAttribute("storage_index", each_stacks.length)
            elem.style.display = "none"
            each_stacks.push(obj)
        }
        let obj = each_stacks[elem.getAttribute("storage_index")]
        try {
            let call = eval(obj.call)
            let html = obj.html
            for (let i = 0; i < call.length; i++) {
                let itemHTML = html
                let evalCalls = new Set(obj.evals)
                evalCalls.forEach(evalCall => {
                    let call = elem.getAttribute("call")
                    let nick = elem.getAttribute("nick")
                    itemHTML = itemHTML.replaceAll(nick, call + `[${i}]`)
                })
                contents.push(evalString(itemHTML))
            }
        }
        catch (error) {  }
        elem.innerHTML = contents.join("\n")
        elem.style = ""
    })
}

let custom_structs = []
function processCustomStructs() {
    document.querySelectorAll(`[custom_struct]`).forEach(elem => {
        custom_structs.push({
            elem: elem,
            name: elem.getAttribute("ui"),
            inputs: elem.getAttribute("inputs"),
            content: elem.innerHTML,
        })
    })
}
function buildCustomStructs() {
    document.querySelectorAll(`[custom_struct_call]`).forEach(elem => {
        let struct = custom_structs.find(struct => struct.name == elem.getAttribute("ui"))
        let inputs = struct?.inputs ? struct.inputs.split(",") : []
        let content = struct?.content
        inputs.forEach(input => {
            input = input?.trim()
            content = content.replaceAll(`$${input}`, elem.getAttribute(input))
        })
        elem.innerHTML = content
    })
}

function evalString(string) {
    let res = string
    let layers = 0
    if (res.includes("{")) {
        let callStack = []
        let callCount = res.split("{").length - 1
        for (let i = 0; i < callCount; i ++) {
            let index = res.indexOf("{")
            let evalStr = ""
            for (let j = index + 1; j < res.length; j++) {
                if (res.charAt(j) == "{") {
                    layers++
                }
                else if (res.charAt(j) == "}") {
                    if (layers > 0) {
                        layers--
                        i++
                    }
                    else {
                        break
                    }
                }
                evalStr += res.charAt(j)
            }
            try {
                callStack.push([`+${evalStr}}`, eval(evalStr?.replaceAll("&quot;", '"'))])
                res = res.replace("{","+")
            }
            catch (error) { }
        }
        callStack.forEach(call => {
            res = res.replace(call[0], call[1])
        })
    }
    try {
        res = eval(res)
    }
    catch (error) { }
    return res
}

function extractEvalStrings(string) {
    let res = string
    let strings = []
    let layers = 0
    if (res.includes("{")) {
        let callCount = res.split("{").length - 1
        for (let i = 0; i < callCount; i ++) {
            let index = res.indexOf("{")
            let evalStr = ""
            for (let j = index + 1; j < res.length; j++) {
                if (res.charAt(j) == "{") {
                    layers++
                }
                else if (res.charAt(j) == "}") {
                    if (layers > 0) {
                        layers--
                        i++
                    }
                    else {
                        break
                    }
                }
                evalStr += res.charAt(j)
            }
            strings.push(evalStr)
        }
    }
    return strings
}

// 
// 
// 
// 
// 
// Library
// 
// 
// 
// 
// 
function Icon(icon) {
    return "<i class='fa-solid fa-" + icon + "'></i>"
    // <i class="fa-solid fa-arrow-left"></i>
}

let encodeHTMLElements = [
    ['"', '&doubleQuote'],
    ["'", "&singleQuote"],
    ["(", "&openParenthesis"],
    [")", "&closeParenthesis"],
    ["[", "&openBracket"],
    ["]", "&closeBracket"],
    ["{", "&openBrace"],
    ["}", "&closeBrace"],
    ["<", "&openHTML"],
    [">", "&closeHTML"],
]
function encodeHTML(html) {
    encodeHTMLElements.forEach(charArr => {
        html = html.replaceAll(charArr[0], charArr[1])
    })
    return html
}
function decodeHTML(html) {
    encodeHTMLElements.forEach(charArr => {
        html = html.replaceAll(charArr[1], charArr[0])
    })
    return html
}
// 
// 
// 
// 
// 
// Storage
// 
// 
// 
// 
// 
const store = {
    key: "song",
    get: key => {
        let storageString = localStorage.getItem("storage_" + store.key) ? localStorage.getItem("storage_" + store.key) : "{}"
        let val = ""
        try {
            let json = JSON.parse(storageString)
            val = json[key]
        } 
        catch (error) { 
            console.error(error)
        }
        if (val !== undefined) {
            return val
        }
        else {
            return null
        }
    },
    set: (key, val, cb) => {
        let storageString = localStorage.getItem("storage_" + store.key) ? localStorage.getItem("storage_" + store.key) : "{}"
        try {
            let json = JSON.parse(storageString)
            json[key] = val
            localStorage.setItem("storage_" + store.key, JSON.stringify(json))
        } catch (error) { 
            return false
        }
        if (cb) cb()
        try {
            updateState()
        }
        catch (error) { }
    },
    safety: (key, val) => {
        let res = store.get(key)
        if (!res) {
            store.set(key, val)
        }
    }
}
document.documentElement.style.setProperty('--hue', 200)
document.documentElement.style.setProperty('--sat', "30%")

mapboxgl.accessToken = 'pk.eyJ1IjoiYWFyb25tZWNoZSIsImEiOiJjbHlucHluNGYwOG1iMmtwcHN5ZmphMjU0In0.ZOvtm2moRAxAlLVWA4YDVQ';
store.safety("position", {coords: {longitude: 0, latitude: 0}})
store.safety("active theme", 2)
store.safety("speed", 0)
store.safety("speed limit", 0)

const dev_locations = {
"Moss Bluff": () => { // LA 378 W, Moss Bluff LA
store.set("position lat", 30.30061)
store.set("position long", -93.19966)
store.set("heading", 270)
},
"Westlake": () => { // I-10 E, Lake Charles LA
store.set("position lat", 30.235925)
store.set("position long", -93.2)
store.set("heading", 90)
},
"Iowa": () => { // I-10 E, Iowa
store.set("position lat", 30.24895)
store.set("position long", -93.01808)
store.set("heading", 85)
},
"Shreveport": () => { // I-49 S into 220 E, Shreveport LA
store.set("position lat", 32.53864)
store.set("position long", -93.79588)
store.set("heading", 185)
},
"Rockton": () => { // Rockton Rd E, Rockton IL
store.set("position lat", 42.45552)
store.set("position long", -89.07037)
store.set("heading", 90)
},
"Milwaukee": () => { // Water St N, Milwaukee WI
store.set("position lat", 43.03896)
store.set("position long", -87.90914)
store.set("heading", 355)
},
"Madison": () => { // W Washington Ave N, Madison WI
store.set("position lat", 43.07162)
store.set("position long", -89.38851)
store.set("heading", 47)
},
"Manhattan": () => { // Park Ave N, Manhattan NY
store.set("position lat", 40.73995)
store.set("position long", -73.98648)
store.set("heading", 28)
},
"Dallas": () => { // I 30 E, Dallas TX
store.set("position lat", 32.75950)
store.set("position long", -97.09440)
store.set("heading", 90)
},
"Seattle": () => { // I 5 N, Seattle WA
store.set("position lat", 47.60956)
store.set("position long", -122.33084)
store.set("heading", 0)
},
}
// dev_locations["Westlake"]()

const map_styles = [
"mapbox://styles/aaronmeche/clyp7z96b007x01qn4rx6fmbb",
"mapbox://styles/aaronmeche/clyp7zcxx027301p80cet1y8p",
"mapbox://styles/aaronmeche/clyp7zbk9007y01qn07169in3",
"mapbox://styles/aaronmeche/clyp85cpy029d01qj4xw772yi",
]

const standard_map_config = () => {
return {
container: 'map',
style: map_styles[0],
center: [store.get("position long"), store.get("position lat")],
bearing: store.get("heading"),
offset: [0, (0.5 * window.innerHeight * (2 / 3))],
zoom: 16,
pitch: 60
}
}

const map = new mapboxgl.Map(standard_map_config())

const el = document.createElement('div')
el.className = "marker"

const marker = new mapboxgl.Marker(el).setLngLat([store.get("position long"), store.get("position lat")]).addTo(map);

let lastPosition = null

if (navigator.geolocation) {
navigator.geolocation.watchPosition(position => {
store.set("position", [position.coords.longitude, position.coords.latitude])
store.set("position lat", position.coords.latitude)
store.set("position long", position.coords.longitude)
store.set("heading", position.coords.heading || 0)
store.set("speed", Math.ceil(Math.floor(position.coords.speed * 2.23694) || 0))
marker.setLngLat([store.get("position long"), store.get("position lat")])
updateAPIs()

if (store.get("live follow") == "on") {
map.easeTo(standard_map_config())
}

}, error => {
console.error('Error getting location: ', error);
}, {
enableHighAccuracy: true,
maximumAge: 500,
timeout: 27000
});
}
else {
console.error('Geolocation is not supported by this browser.');
}

function updateAPIs() {
// APIs
updateFeaturesAPI()
updateRoadAPI()
updateCurrentElevationAPI()
updateWeatherAPI()

// TimeManager
updateSunTimesAPI()
}

function handleUserInteraction() {
store.set("live follow", "off")
}

map.on('dragstart', () => handleUserInteraction());
map.on('pitchstart', () => handleUserInteraction());
map.easeTo(standard_map_config())
updateAPIs()
function updateFeaturesAPI() {
const featureUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${store.get("position long")},${store.get("position lat")}.json?access_token=${mapboxgl.accessToken}`;
fetch(featureUrl)
.then(response => response.json())
.then(data => {
if (data.features && data.features.length > 0) {
const features = data.features
store.set("features", features)
store.set("current city", features.find(feature => feature.place_type.includes("place")).text)
store.set("current county", features.find(feature => feature.place_type.includes("district")).text)
store.set("current state", features.find(feature => feature.place_type.includes("region")).text)
}
})
.catch(error => console.error('Error with features api:', error));
}

function updateRoadAPI() {
const url = `https://overpass-api.de/api/interpreter?data=[out:json];way(around:10,${store.get("position lat")},${store.get("position long")})[maxspeed];out;`;

fetch(url)
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok ' + response.statusText);
}
return response.json();
})
.then(data => {
try {
store.set("speed limit", data.elements[0].tags.maxspeed.split(" ")[0])
store.set("road name", data.elements[0].tags.name ? data.elements[0].tags.name.replaceAll(";", " / ") : data.elements[0].tags.ref.replaceAll(";", " / "))
}
catch (error) {
store.set("road name", store.get("current city"))
}
})
.catch(error => {
return 'Error fetching speed limit'
});
}

function updateCurrentElevationAPI() {
const url = `https://api.open-elevation.com/api/v1/lookup?locations=${store.get("position lat")},${store.get("position long")}`;

fetch(url)
.then(response => response.json())
.then(data => {
store.set("elevation", data.results[0].elevation)
})
.catch(error => {

})
}

function updateWeatherAPI() {
const url = `https://api.openweathermap.org/data/2.5/weather?lat=${store.get("position lat")}&lon=${store.get("position long")}&appid=1f263bb5882c1fdce34a6513a3b48025&units=metric`
fetch(url)
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok ' + response.statusText);
}
return response.json();
})
.then(data => {
console.log(data)
})
.catch(error => {
console.error('There has been a problem with your fetch operation:', error);
});
}
function getColor(colorName, opacity) {
const colors = {
"white": "255, 255, 255",
"black": "0, 0, 0"
}
return colors[colorName] + (opacity ? `, ${opacity}` : "")
}

const timeManager = {
dawn: () => {
map.setStyle(map_styles[0])
timeManager.mode("light")
},
day: () => {
map.setStyle(map_styles[1])
timeManager.mode("light")
},
dusk: () => {
map.setStyle(map_styles[2])
timeManager.mode("dark")
},
night: () => {
map.setStyle(map_styles[3])
timeManager.mode("dark")
},
light: {
primary: getColor("white"),
primary75: getColor("white", 0.75),
primary50: getColor("white", 0.5),
primary25: getColor("white", 0.25),
content: getColor("black"),
content75: getColor("black", 0.75),
content50: getColor("black", 0.5),
content25: getColor("black", 0.25),
},
dark: {
primary: getColor("black"),
primary75: getColor("black", 0.75),
primary50: getColor("black", 0.5),
primary25: getColor("black", 0.25),
content: getColor("white"),
content75: getColor("white", 0.75),
content50: getColor("white", 0.5),
content25: getColor("white", 0.25),
},
mode: (mode) => {
let obj = mode == "light" ? timeManager.light : timeManager.dark
Object.keys(obj).forEach(key => {
document.documentElement.style.setProperty("--" + key, "rgb(" + obj[key] + ")")
})
},
}

function updateSunTimesAPI() {
const url = `https://api.sunrise-sunset.org/json?lat=${store.get("position lat")}&lng=${store.get("position long")}&formatted=0`;

fetch(url)
.then(response => {
if (!response.ok) {
throw new Error('Network response was not ok ' + response.statusText);
}
return response.json();
})
.then(data => {
const dawn = new Date(data.results.civil_twilight_begin);
const day = new Date(data.results.sunrise);
const dusk = new Date(data.results.civil_twilight_end);
const night = new Date(data.results.nautical_twilight_end);
const now = new Date()

if (now < dawn) {
timeManager.night()
}
else if (now < day) {
timeManager.dawn()
}
else if (now < dusk) {
timeManager.day()
}
else if (now < night) {
timeManager.dusk()
}
else {
timeManager.night()
}
})
.catch(error => {
console.error('Error fetching sun times:', error);
});
}

// state_func.push(() => {

// })

store.safety("speed", 0)
store.set("live follow", "on")
store.set("dimension", 3)

function toggleDimension() {
let dimension = store.get("dimension")
if (dimension == 2) {
map.easeTo({ pitch: 60 })
store.set("dimension", 3)
}
else {
map.easeTo({ pitch: 0 })
store.set("dimension", 2)
}
}

function currentLocation() {
map.easeTo(standard_map_config())
store.set("live follow", "on")
}
store.safety("speed", 0)
store.set("live follow", "on")
store.set("dimension", 3)

function toggleDimension() {
let dimension = store.get("dimension")
if (dimension == 2) {
map.easeTo({ pitch: 60 })
store.set("dimension", 3)
}
else {
map.easeTo({ pitch: 0, offset: [0, 0], center: [store.get("position long"), store.get("position lat")] })
store.set("dimension", 2)
}
}

function currentLocation() {
map.easeTo(standard_map_config())
store.set("live follow", "on")
store.set("dimension", 3)
}
</script>